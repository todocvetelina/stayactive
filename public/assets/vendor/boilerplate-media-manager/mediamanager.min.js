function loadPath(e,t=!1){$("#loading").css({position:"absolute",display:"flex",width:$("#media-content").width(),height:0===$("#media-content").height()?200:$("#media-content").height()}),$.ajax({url:routes.ajaxList,type:"post",data:{path:e,display:$("#media-content").data("display"),type:$("#media-content").data("type"),clearcache:t},success:function(t){$("#media-content").html(t),$("#media-content").data("path",$("#media-list").data("path")),$('.media[data-url="'+$("#media-content").data("selected")+'"]').addClass("selected"),$(".lazy").lazy(),showMove(),uploadButton(e),$("#loading").css("display","none")}})}function uploadButton(e){$("#fileupload").fileupload({dataType:"json",formData:{path:e},url:routes.ajaxUpload,start:function(){$("#disable,#progress").show()},progressall:function(e,t){var a=parseInt(t.loaded/t.total*100,10);$("#progress .progress-bar").css("width",a+"%").text(a+"%")},fail:function(e,t){growl(t.files[0].name+" : "+t.jqXHR.responseJSON.error,"danger")},always:function(t,a){"error"===a.jqXHR.responseJSON.status&&growl(a.files[0].name+" : "+a.jqXHR.responseJSON.error,"danger"),1===$("#fileupload").fileupload("active")&&(growl(locales.uploadSuccess,"success"),$("#disable").hide(),loadPath(e))}})}function showMove(){if(0!==clipboard.files.length){$("#nb-files-selected").text(clipboard.files.length),$("#btn-paste-group").show(),$("#media-content .card-header").addClass("blur"),$(".btn-paste").attr("disabled",!0);var e=!0;clipboard.files.forEach((function(t){($("#media-list").data("path").startsWith(("/"===clipboard.path?"":clipboard.path)+"/"+t)||$("#media-list").data("path")===clipboard.path)&&(e=!1)})),e&&$(".btn-paste").attr("disabled",!1)}}$((function(){localStorage.getItem("mediamanager_list_display")&&$("#media-content").attr("data-display",localStorage.getItem("mediamanager_list_display")),$(document).on("click",".link-media",(function(e){e.preventDefault(),1===$("#media-content").data("mce")?""!==$("#media-content").data("field")?window.parent.postMessage({action:"insertMedia",url:$(this).attr("href"),name:$(this).attr("data-filename"),field:$("#media-content").data("field"),type:$("#media-content").data("return")},"*"):void 0!==parent.tinymce&&window.parent.postMessage({mceAction:"insertMedia",url:$(this).attr("href"),name:$(this).attr("data-filename")},"*"):$(this).closest(".media").find('input[type="checkbox"]').trigger("click")})),$(document).on("click",".btn-refresh",(function(e){e.preventDefault(),loadPath($("#media-content").data("path"),!0)})),$(document).on("click",".check-all",(function(){$('.media input[type="checkbox"]').prop("checked",$(this).prop("checked")).trigger("change")})),$(document).on("change",'.media input[type="checkbox"]',(function(e){var t=$('.media input[type="checkbox"]:checked');$(".delete-checked, .copy-checked").attr("disabled",!t.length>0)})),$(document).on("click",".delete-checked:enabled",(function(e){e.preventDefault(),bootbox.confirm(locales.deleteConfirm,(function(e){if(!1!==e){$("#disable").show();var t=$('.media input[type="checkbox"]:checked'),a=[];t.each((function(e,t){a.push($(t).val())})),$.ajax({url:routes.ajaxDelete,type:"post",data:{path:$("#media-list").data("path"),files:a},success:function(e){"success"===e.status?(growl(locales.deleteSuccess,"success"),$("#disable").hide(),$(a).each((function(e,t){$('.media[data-filename="'+t+'"]').remove()})),$('.media input[type="checkbox"]').trigger("change"),0===$("#media-list .media").length&&$(".btn-refresh").trigger("click")):growl(e.message,"error")}})}}))})),$(document).on("click",".copy-checked:enabled",(function(e){e.preventDefault();var t=$('.media input[type="checkbox"]:checked');clipboard.path=$("#media-list").data("path"),clipboard.files=[],t.each((function(e,t){clipboard.files.push($(t).val())})),$("#nb-files-selected").text(clipboard.files.length),$("#btn-paste-group").show()})),$(document).on("click",".btn-paste",(function(e){e.preventDefault(),$.ajax({url:routes.ajaxPaste,type:"post",data:{destination:$("#media-list").data("path"),from:clipboard.path,files:clipboard.files},success:function(e){"success"===e.status?(loadPath($("#media-list").data("path")),growl(locales.pasteSuccess,"success"),clipboard.files=[],$('.media input[type="checkbox"]').trigger("change")):growl(e.message,"error")}})})),$(document).on("click",".btn-paste-cancel",(function(e){e.preventDefault(),clipboard.files=[],$("#btn-paste-group").hide()})),$(document).on("click",".btn-delete",(function(e){e.preventDefault(),e.stopPropagation();var t=$("#media-content").data("path"),a=$(this).attr("data-filename"),n=[];n.push(a),bootbox.confirm(locales.deleteConfirm,(function(e){!1!==e&&$.ajax({url:routes.ajaxDelete,type:"post",data:{path:t,files:n},success:function(){growl(locales.deleteSuccess,"success"),$(n).each((function(e,t){$('.media[data-filename="'+t+'"]').remove()})),0===$("#media-list .media").length&&$(".btn-refresh").trigger("click")}})}))})),$(document).on("click","a.add-folder",(function(e){e.preventDefault();var t=$("#media-content").data("path");bootbox.prompt(locales.folderName,(function(e){null!==e&&""!==e&&$.ajax({url:routes.newFolder,type:"post",data:{path:t,name:e},success:function(){growl(locales.folderSuccess,"success"),loadPath(t)}})}))})),$(document).on("click",".btn-toggle-display",(function(e){e.preventDefault(),$(".btn-toggle-display").toggleClass("btn-secondary").toggleClass("btn-default"),$("#media-content").data("display",$(this).data("display")),localStorage.setItem("mediamanager_list_display",$(this).data("display")),loadPath($("#media-content").data("path"))})),$(document).on("click",".btn-rename",(function(e){e.preventDefault(),e.stopPropagation();let t=$("#media-content").data("path"),a=$(this).attr("data-filename"),n=$(this).attr("data-type"),o="folder"===n?a:$(this).attr("data-name");bootbox.prompt({title:locales.renameTitle,value:o,callback:function(e){null!==e&&""!==e&&$.ajax({url:routes.rename,type:"post",data:{path:t,type:n,fileName:a,newName:e},success:function(e){"success"===e.status?growl(locales.renameSuccess,"success"):growl(e.message,"error"),loadPath(t)}})}})})),$(document).on("click",".btn-view",(function(e){e.preventDefault(),e.stopPropagation(),window.open($(this).attr("href"),"_blank")})),$(document).on("click","#media-breadcrumb a, #media-list a.link-folder",(function(e){e.preventDefault();var t=$(this).attr("href");history.pushState({page:t},"",t),loadPath(t)})),$(window).on("popstate",(function(){loadPath(location.pathname)})),loadPath($("#media-content").data("path"))}));
